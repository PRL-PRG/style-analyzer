---
title: "style-analyzer: The missing artifact"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{R}
library(readr)
library(dplyr)
library(stringr)
library(kableExtra)
```

```{r}
REPRO_DIR <- "reproductions/original_reproduction/"
DJANCO_DIR <- "style-analyzer-query/output/"

# Convert to bash variables
Sys.setenv(REPRO_DIR = REPRO_DIR)
```

```{bash}
# Calculate prediction rates by analyzing the log.
scripts/extract_prediction_rate.awk \
    <"${REPRO_DIR}/logs.txt" \
    >"${REPRO_DIR}/predictions.csv" 

# Convert summary test report into CSV.
scripts/extract_summary.awk \
    <"${REPRO_DIR}/summary-test_report.md" \
    >"${REPRO_DIR}/summary.csv"

# Extract unique label counts from individual reports.
scripts/extract_number_of_labels.sh \
     "${REPRO_DIR}/" \
    >"${REPRO_DIR}/labels.csv" 
```

```{r}
# Paths
all_projects_path <- paste0(DJANCO_DIR, "javascript_projects.csv")
project_locs_path <- paste0(DJANCO_DIR, "project_locs.csv")
predictions_path <- paste0(REPRO_DIR, "predictions.csv")
summary_path <- paste0(REPRO_DIR, "summary.csv")
labels_path <- paste0(REPRO_DIR, "labels.csv")

# Some helper functions
url_to_repo <- function(url) str_replace_all(url, c("(^.*/)|([.]git$)"), "")

# CSVs
all_projects <- read_csv(all_projects_path) %>% mutate(repo = url_to_repo(url))
project_locs <- read_csv(project_locs_path) %>% mutate(repo = url_to_repo(url))
predictions <- read_csv(predictions_path) %>% select(-url) # there is one in project_locs and this one has a different format
summary <- read_csv(summary_path)
labels <- read_csv(labels_path)

# Collate results
results <- summary %>%
  left_join(project_locs, by="repo") %>%
  left_join(labels, by="repo") %>% 
  left_join(predictions, by="repo") %>%
  mutate(training_time=NA) # TODO
```

Results table a la the paper:

```{r}
data <- 
  results %>% 
  select(-recall, -f1) %>%
  rename(
         pred_r=predictions/samples, 
         recall=full_recall, 
         f1=full_f1,
         suppport=full_support,
         rules=`Rules Number`) %>%
  select(repo, precision, pred_r, 
         recall, f1, support, 
         rules, locs, labels, 
         training_time)

average <- 
  data %>% 
  summarize(repo = "average", 
            precision = mean(precision, na.rm=TRUE),
            pred_r = mean(pred_r, na.rm=TRUE), 
            recall = mean(recall, na.rm=TRUE),
            f1 = mean(f1, na.rm=TRUE),
            support = mean(support, na.rm=TRUE),
            rules = mean(rules, na.rm=TRUE),
            locs = mean(locs, na.rm=TRUE),
            labels = mean(labels, na.rm=TRUE),
            training_time = mean(training_time, na.rm=TRUE))

weighted_average <- 
  data %>% 
  summarize(repo = "weighted average", 
            precision = weighted.mean(precision, support),
            pred_r = weighted.mean(pred_r, support), 
            recall = weighted.mean(recall, support),
            f1 = weighted.mean(f1, support),
            support = NA,
            rules = weighted.mean(rules, support),
            locs = weighted.mean(locs, support),
            labels = weighted.mean(labels, support),
            training_time = weighted.mean(training_time, support))

```
